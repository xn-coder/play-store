<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body data-page="owner-dashboard">
    <div th:fragment="content">
        <div class="container">
            <h2>Owner Dashboard</h2>
            <div class="dashboard-container">
                <div class="upload-app-form">
                    <h3>Upload New App</h3>
                    <form id="upload-app-form" onsubmit="handleUpload(event)">
                        <div>
                            <label for="app-name">App Name</label>
                            <input type="text" id="app-name" required>
                        </div>
                        <div>
                            <label for="app-description">App Description</label>
                            <textarea id="app-description" required></textarea>
                        </div>
                        <div>
                            <label for="app-price">Price</label>
                            <input type="number" id="app-price" required>
                        </div>
                        <div>
                            <label for="app-category">Category</label>
                             <select id="app-category" required>
                                <option value="Apps">App</option>
                                <option value="Games">Game</option>
                            </select>
                        </div>
                        <button type="submit">Upload App</button>
                    </form>
                </div>
                <div class="owner-apps-table">
                    <h3>Your Apps</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>App Name</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="owner-apps-tbody">
                            <!-- Owner's apps will be dynamically loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                updateNav();
                if (!isLoggedIn()) {
                    window.location.href = '/login';
                    return;
                }
                loadOwnerApps();
            });

            function handleUpload(e) {
                e.preventDefault();
                const appName = document.getElementById('app-name').value;
                const appDescription = document.getElementById('app-description').value;
                const appPrice = parseFloat(document.getElementById('app-price').value);
                const appCategory = document.getElementById('app-category').value;
                const owner = JSON.parse(localStorage.getItem('loggedInUser'));

                const apps = JSON.parse(localStorage.getItem('apps')) || [];
                apps.push({
                    id: Date.now(),
                    name: appName,
                    description: appDescription,
                    price: appPrice,
                    category: appCategory,
                    owner: owner.username
                });
                localStorage.setItem('apps', JSON.stringify(apps));
                alert('App uploaded successfully!');
                loadOwnerApps();
                document.getElementById('upload-app-form').reset();
            }

            function loadOwnerApps() {
                const tbody = document.getElementById('owner-apps-tbody');
                const owner = JSON.parse(localStorage.getItem('loggedInUser'));
                const allApps = JSON.parse(localStorage.getItem('apps')) || [];
                const ownerApps = allApps.filter(app => app.owner === owner.username);

                tbody.innerHTML = '';
                ownerApps.forEach(app => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${app.name}</td>
                        <td>${app.description}</td>
                        <td>$${app.price.toFixed(2)}</td>
                        <td>${app.category}</td>
                        <td><button onclick="deleteApp(${app.id})">Delete</button></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            function deleteApp(appId) {
                let apps = JSON.parse(localStorage.getItem('apps')) || [];
                apps = apps.filter(app => app.id !== appId);
                localStorage.setItem('apps', JSON.stringify(apps));
                loadOwnerApps();
            }

            function isLoggedIn() {
                return !!localStorage.getItem('loggedInUser');
            }

            function updateNav() {
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                const navAuth = document.querySelector('.nav-auth');

                if (loggedInUser) {
                    navAuth.innerHTML = `
                        ${loggedInUser.role === 'owner' ? '<li><a href="/owner-dashboard" class="active">Dashboard</a></li>' : ''}
                        <li><a href="#" id="logout-btn">Logout</a></li>
                    `;
                     const logoutBtn = document.getElementById('logout-btn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', () => {
                            localStorage.removeItem('loggedInUser');
                            updateNav();
                            window.location.href = '/login';
                        });
                    }
                } else {
                    navAuth.innerHTML = `
                        <li><a href="/login">Login</a></li>
                        <li><a href="/register">Register</a></li>
                    `;
                }
            }
        </script>
    </div>
</body>
</html>